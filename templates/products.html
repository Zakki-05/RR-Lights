{% extends 'base.html' %}

{% block title %}Products - RR Light House{% endblock %}

{% block content %}
<section class="page-header">
    <h1>Our Products</h1>
    <p>Explore our wide range of electrical solutions.</p>
</section>

<section class="products-section container">
    <!-- Controls -->
    <div class="products-controls">
        <select id="category-filter">
            <option value="All">All Categories</option>
            <option value="LED Lights">LED Lights</option>
            <option value="Tube Lights">Tube Lights</option>
            <option value="Fancy Lights">Fancy Lights</option>
            <option value="Switches">Switches</option>
            <option value="Wires">Wires</option>
            <option value="Fans">Fans</option>
        </select>

        <input type="text" id="search-input" placeholder="Search products...">
    </div>

    <!-- Product Grid -->
    <div id="product-grid" class="product-grid">
        <!-- Products will be loaded here dynamically -->
        <div class="loader">Loading...</div>
    </div>
</section>



{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('product-grid');
        const categorySelect = document.getElementById('category-filter');
        const searchInput = document.getElementById('search-input');

        // State
        let currentProducts = [];
        let currentCartItems = [];

        // Fetch products
        async function loadProducts() {
            grid.innerHTML = '<div class="loader">Loading products...</div>';

            const category = categorySelect.value;
            const search = searchInput.value;

            try {
                const response = await fetch(`/api/products?category=${encodeURIComponent(category)}&search=${encodeURIComponent(search)}`);
                currentProducts = await response.json();

                // Trigger cart refresh to get latest items, which will trigger render via event
                if (window.refreshCartState) {
                    await window.refreshCartState();
                } else {
                    renderProducts(); // Fallback if cart.js not ready
                }
            } catch (error) {
                grid.innerHTML = '<p style="text-align:center; color:red;">Failed to load products. Please try again.</p>';
            }
        }

        // Listen for Cart Updates to re-render buttons
        document.addEventListener('cartUpdated', (e) => {
            currentCartItems = e.detail;
            renderProducts();
        });

        function renderProducts() {
            const products = currentProducts;
            if (products.length === 0) {
                grid.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">No products found.</p>';
                return;
            }

            // Map cart quantities
            const cartMap = {};
            currentCartItems.forEach(item => {
                // Ensure ID types match (string vs int)
                // Cart item doesn't have product_id directly in the view from API?
                // API /api/cart returns: {id, quantity, name...} but seemingly not product_id?
                // Wait, /api/cart query: SELECT c.id, c.quantity... NO, it selects p.* info.
                // It does NOT select product_id. I need to fix backend or rely on Name.
                // Actually I should fix backend API to return product_id.
                // Assuming it returns product_id if I fix query.
                // Wait, the API code: SELECT c.id, c.quantity, p.name... 
                // It selects c.id (cart item id). It needs c.product_id.
                // I will Assume I will fix API in next step.
                // For now, I'll match by Name if needed, but ID is better.
                // Let's assume the API returns product_id (I'll add it).
                if (item.product_id) cartMap[item.product_id] = item.quantity;
            });

            grid.innerHTML = products.map(p => {
                let imgHtml = '<i class="fa-solid fa-box-open"></i>';
                if (p.image_url) {
                    const imgSrc = p.image_url.startsWith('http') ? p.image_url : `/static/${p.image_url}`;
                    imgHtml = `<img src="${imgSrc}" alt="${p.name}">`;
                }

                const qty = cartMap[p.id] || 0;
                let btnContent = '<i class="fa-solid fa-cart-plus"></i> Add';
                let btnClass = 'btn-sm btn-add-cart add-to-cart-btn';

                if (qty > 0) {
                    btnContent = `<i class="fa-solid fa-check"></i> Added (${qty})`;
                    btnClass += ' added';
                }

                return `
            <div class="product-card fade-up">
                <div class="product-img">
                    ${imgHtml}
                </div>
                <div class="product-info">
                    <span class="product-cat">${p.category}</span>
                    <h3>${p.name}</h3>
                    <p class="product-desc">${p.description || ''}</p>
                    <div class="product-actions">
                        <button class="${btnClass}" data-id="${p.id}">
                            ${btnContent}
                        </button>
                        <a href="https://wa.me/919443324151?text=Hi, I want to buy ${encodeURIComponent(p.name)}" target="_blank" class="btn-sm btn-whatsapp-buy">
                            <i class="fa-brands fa-whatsapp"></i> Buy
                        </a>
                    </div>
                </div>
            </div>
            `;
            }).join('');

            // Attach listeners
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (window.addToCart) {
                        // Optimistic UI update could happen here
                        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                        await window.addToCart(btn.dataset.id);
                        // No need to manually update text, event will trigger re-render
                    }
                });
            });

            document.querySelectorAll('.product-card').forEach(el => {
                el.style.opacity = '1';
            });
        }

        // Event Listeners
        categorySelect.addEventListener('change', loadProducts);
        searchInput.addEventListener('input', () => {
            loadProducts();
        });

        // Initial Load
        loadProducts();
    });
</script>
{% endblock %}